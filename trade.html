<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade - TradeSpotter</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo">TradeSpotter</a>
        <div class="header-actions">
            <a href="index.html" class="btn btn-secondary">‚Üê Retour</a>
            <button class="btn btn-danger" id="btnDelete" style="display:none" onclick="handleDelete()">üóëÔ∏è Supprimer</button>
        </div>
    </header>

    <main class="container">
        <!-- Banner pour extension -->
        <div class="extension-banner" id="extensionBanner" style="display:none">
            <span>üì∏ Screenshot dans le presse-papier</span>
            <span class="hint">Cliquez sur la zone image + <kbd>Ctrl</kbd>+<kbd>V</kbd> pour coller</span>
        </div>

        <!-- Identification -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìã Identification</h2>
                <span class="badge" id="statusBadge"></span>
            </div>
            <div class="card-content">
                <!-- √âtat d'esprit en premier -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">√âtat d'esprit</label>
                    <div class="mindset-toggle">
                        <button type="button" class="mindset-btn" data-value="plan" onclick="setMindset('plan')">üéØ Je respecte le plan</button>
                        <button type="button" class="mindset-btn intuitif" data-value="intuitif" onclick="setMindset('intuitif')">üé≤ Mode intuitif</button>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Actif</label>
                        <input type="text" class="form-input" id="asset" placeholder="BTCUSD" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="tradeDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Heure</label>
                        <input type="time" class="form-input" id="tradeTime">
                    </div>
                    <div class="form-group">
                        <label class="form-label">TF HTF</label>
                        <select class="form-select" id="tfHTF">
                            <option value="">--</option>
                            <option value="M15">M15</option>
                            <option value="M30">M30</option>
                            <option value="H1">H1</option>
                            <option value="H4">H4</option>
                            <option value="D1">D1</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">TF LTF</label>
                        <select class="form-select" id="tfLTF">
                            <option value="">--</option>
                            <option value="M1">M1</option>
                            <option value="M5">M5</option>
                            <option value="M15">M15</option>
                            <option value="M30">M30</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mode</label>
                        <select class="form-select" id="mode">
                            <option value="live">üî¥ Live</option>
                            <option value="backtest">üìö Backtest</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Direction</label>
                    <div class="direction-toggle">
                        <button type="button" class="direction-btn long" onclick="setDirection('long')">üìà LONG</button>
                        <button type="button" class="direction-btn short" onclick="setDirection('short')">üìâ SHORT</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Checklist ICT -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">‚úÖ Checklist ICT</h2>
            </div>
            <div class="card-content">
                <!-- Liquidation HTF -->
                <div class="checklist-item">
                    <div class="checklist-header" onclick="toggleChecklist('liqHTF')">
                        <div class="checklist-checkbox" id="checkLiqHTF">‚úì</div>
                        <span class="checklist-label">Liquidation HTF</span>
                    </div>
                    <div class="checklist-details" id="detailsLiqHTF">
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label class="form-label">Type</label>
                                <div class="option-group" data-field="liqHTFType">
                                    <button class="option-btn" data-value="BSL">BSL</button>
                                    <button class="option-btn" data-value="SSL">SSL</button>
                                    <button class="option-btn" data-value="EQH">EQH</button>
                                    <button class="option-btn" data-value="EQL">EQL</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Force</label>
                                <div class="option-group" data-field="liqHTFForce">
                                    <button class="option-btn" data-value="faible">Faible</button>
                                    <button class="option-btn" data-value="forte">Forte</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liquidation LTF -->
                <div class="checklist-item">
                    <div class="checklist-header" onclick="toggleChecklist('liqLTF')">
                        <div class="checklist-checkbox" id="checkLiqLTF">‚úì</div>
                        <span class="checklist-label">Liquidation LTF</span>
                    </div>
                    <div class="checklist-details" id="detailsLiqLTF">
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label class="form-label">Type</label>
                                <div class="option-group" data-field="liqLTFType">
                                    <button class="option-btn" data-value="BSL">BSL</button>
                                    <button class="option-btn" data-value="SSL">SSL</button>
                                    <button class="option-btn" data-value="EQH">EQH</button>
                                    <button class="option-btn" data-value="EQL">EQL</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Force</label>
                                <div class="option-group" data-field="liqLTFForce">
                                    <button class="option-btn" data-value="faible">Faible</button>
                                    <button class="option-btn" data-value="forte">Forte</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOS -->
                <div class="checklist-item">
                    <div class="checklist-header" onclick="toggleChecklist('bos')">
                        <div class="checklist-checkbox" id="checkBOS">‚úì</div>
                        <span class="checklist-label">BOS dans le sens HTF</span>
                    </div>
                    <div class="checklist-details" id="detailsBOS">
                        <div class="form-grid-3">
                            <div class="form-group">
                                <label class="form-label">Pris avant cl√¥ture ?</label>
                                <div class="option-group" data-field="bosAvantCloture">
                                    <button class="option-btn" data-value="oui">Oui</button>
                                    <button class="option-btn" data-value="non">Non</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">M√®che ou Corps ?</label>
                                <div class="option-group" data-field="bosMecheCorps">
                                    <button class="option-btn" data-value="meche">M√®che</button>
                                    <button class="option-btn" data-value="corps">Corps</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Prend une liquidit√© ?</label>
                                <div class="option-group" data-field="bosLiquidite">
                                    <button class="option-btn" data-value="non">Non</button>
                                    <button class="option-btn" data-value="TR">TR</button>
                                    <button class="option-btn" data-value="EQH">EQH</button>
                                    <button class="option-btn" data-value="EQL">EQL</button>
                                    <button class="option-btn" data-value="TL">TL</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Objectif -->
                <div class="checklist-item">
                    <div class="checklist-header" onclick="toggleChecklist('objectif')">
                        <div class="checklist-checkbox" id="checkObjectif">‚úì</div>
                        <span class="checklist-label">Objectif de liquidit√© clair</span>
                    </div>
                    <div class="checklist-details" id="detailsObjectif">
                        <div class="form-group">
                            <label class="form-label">Type d'objectif</label>
                            <div class="option-group" data-field="objectifType">
                                <button class="option-btn" data-value="BSL">BSL</button>
                                <button class="option-btn" data-value="SSL">SSL</button>
                                <button class="option-btn" data-value="EQH">EQH</button>
                                <button class="option-btn" data-value="EQL">EQL</button>
                                <button class="option-btn" data-value="FVG">FVG</button>
                                <button class="option-btn" data-value="OB">OB</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scoring -->
                <div style="margin-top: 1.5rem;">
                    <label class="form-label" style="margin-bottom: 1rem; display: block;">‚≠ê Scoring</label>
                    <div class="scoring-grid">
                        <div class="scoring-row">
                            <span class="scoring-label">Liq HTF</span>
                            <div class="stars" data-score="liqHTF">
                                <span class="star" onclick="setScore('liqHTF', 1)">‚òÜ</span>
                                <span class="star" onclick="setScore('liqHTF', 2)">‚òÜ</span>
                                <span class="star" onclick="setScore('liqHTF', 3)">‚òÜ</span>
                                <span class="star" onclick="setScore('liqHTF', 4)">‚òÜ</span>
                                <span class="star" onclick="setScore('liqHTF', 5)">‚òÜ</span>
                            </div>
                        </div>
                        <div class="scoring-row">
                            <span class="scoring-label">Liq LTF</span>
                            <div class="stars" data-score="liqLTF">
                                <span class="star" onclick="setScore('liqLTF', 1)">‚òÜ</span>
                                <span class="star" onclick="setScore('liqLTF', 2)">‚òÜ</span>
                                <span class="star" onclick="setScore('liqLTF', 3)">‚òÜ</span>
                                <span class="star" onclick="setScore('liqLTF', 4)">‚òÜ</span>
                                <span class="star" onclick="setScore('liqLTF', 5)">‚òÜ</span>
                            </div>
                        </div>
                        <div class="scoring-row">
                            <span class="scoring-label">BOS</span>
                            <div class="stars" data-score="bos">
                                <span class="star" onclick="setScore('bos', 1)">‚òÜ</span>
                                <span class="star" onclick="setScore('bos', 2)">‚òÜ</span>
                                <span class="star" onclick="setScore('bos', 3)">‚òÜ</span>
                                <span class="star" onclick="setScore('bos', 4)">‚òÜ</span>
                                <span class="star" onclick="setScore('bos', 5)">‚òÜ</span>
                            </div>
                        </div>
                        <div class="scoring-row">
                            <span class="scoring-label">Objectif</span>
                            <div class="stars" data-score="objectif">
                                <span class="star" onclick="setScore('objectif', 1)">‚òÜ</span>
                                <span class="star" onclick="setScore('objectif', 2)">‚òÜ</span>
                                <span class="star" onclick="setScore('objectif', 3)">‚òÜ</span>
                                <span class="star" onclick="setScore('objectif', 4)">‚òÜ</span>
                                <span class="star" onclick="setScore('objectif', 5)">‚òÜ</span>
                            </div>
                        </div>
                        <div class="scoring-total">
                            <div class="scoring-value" id="scoreAvg">-</div>
                            <div class="scoring-label-big">Moyenne</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screenshots -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üì∏ Screenshots</h2>
            </div>
            <div class="card-content">
                <div class="images-grid">
                    <!-- Entr√©e -->
                    <div class="image-field">
                        <label>Prise du trade (entr√©e)</label>
                        <input type="text" class="form-input" id="imgEntryUrl" placeholder="Lien TradingView ou URL image..." style="margin-bottom: 0.5rem;">
                        <div class="image-drop-zone" id="dropEntry" tabindex="0">
                            <div class="icon">üì∑</div>
                            <div class="text">Glisser une image ou Ctrl+V</div>
                            <div class="hint">ou cliquer pour s√©lectionner</div>
                        </div>
                        <div class="image-preview-container" id="previewEntryContainer">
                            <img class="image-preview" id="previewEntry" onclick="zoomImage(this.src)">
                            <button class="btn-remove-image" onclick="removeImage('entry')">‚úï</button>
                        </div>
                    </div>

                    <!-- Contexte -->
                    <div class="image-field">
                        <label>Contexte HTF</label>
                        <input type="text" class="form-input" id="imgContextUrl" placeholder="Lien TradingView ou URL image..." style="margin-bottom: 0.5rem;">
                        <div class="image-drop-zone" id="dropContext" tabindex="0">
                            <div class="icon">üì∑</div>
                            <div class="text">Glisser une image ou Ctrl+V</div>
                            <div class="hint">ou cliquer pour s√©lectionner</div>
                        </div>
                        <div class="image-preview-container" id="previewContextContainer">
                            <img class="image-preview" id="previewContext" onclick="zoomImage(this.src)">
                            <button class="btn-remove-image" onclick="removeImage('context')">‚úï</button>
                        </div>
                    </div>

                    <!-- Sortie -->
                    <div class="image-field">
                        <label>Fin du trade</label>
                        <input type="text" class="form-input" id="imgExitUrl" placeholder="Lien TradingView ou URL image..." style="margin-bottom: 0.5rem;">
                        <div class="image-drop-zone" id="dropExit" tabindex="0">
                            <div class="icon">üì∑</div>
                            <div class="text">Glisser une image ou Ctrl+V</div>
                            <div class="hint">ou cliquer pour s√©lectionner</div>
                        </div>
                        <div class="image-preview-container" id="previewExitContainer">
                            <img class="image-preview" id="previewExit" onclick="zoomImage(this.src)">
                            <button class="btn-remove-image" onclick="removeImage('exit')">‚úï</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- R√©sultat -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üéØ R√©sultat</h2>
            </div>
            <div class="card-content">
                <div class="result-options">
                    <button class="result-btn encours" onclick="setStatus('encours')">üîÑ En cours</button>
                    <button class="result-btn tp" onclick="setStatus('tp')">‚úÖ TP</button>
                    <button class="result-btn be" onclick="setStatus('be')">‚öñÔ∏è BE</button>
                    <button class="result-btn sl" onclick="setStatus('sl')">‚ùå SL</button>
                    <button class="result-btn positif" onclick="setStatus('positif')">üí∞ Positif</button>
                </div>

                <div class="form-grid-2" style="margin-top: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Potentiel du trade (R)</label>
                        <input type="number" class="form-input" id="potentielR" step="0.1" placeholder="Ex: 3.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">R obtenu</label>
                        <input type="number" class="form-input" id="rObtenu" step="0.1" placeholder="Ex: 2.0">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Notes / Analyse</label>
                    <textarea class="form-textarea" id="notes" placeholder="Ce qui a bien/mal fonctionn√©..."></textarea>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-bar">
            <button class="btn btn-primary" id="btnSave" onclick="handleSave()">üíæ Enregistrer</button>
        </div>
    </main>

    <!-- Modal Image -->
    <div class="modal-overlay" id="imageModal" onclick="closeModal()">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        <img class="modal-image" id="modalImage">
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <style>
        /* Banner extension */
        .extension-banner {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.15), rgba(0, 212, 170, 0.05));
            border: 1px solid var(--accent-bull);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: bannerPulse 2s ease-in-out infinite;
        }
        .extension-banner span:first-child {
            font-weight: 600;
            color: var(--accent-bull);
        }
        .extension-banner .hint {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .extension-banner kbd {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
        }
        @keyframes bannerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Highlight pour drop zone quand vient de l'extension */
        .image-drop-zone.from-extension {
            border-color: var(--accent-bull);
            animation: dropZonePulse 1.5s ease-in-out infinite;
        }
        @keyframes dropZonePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(0, 212, 170, 0); }
        }
    </style>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/trades.js"></script>
    <script src="js/images.js"></script>
    <script>
        // State
        let tradeId = null;
        let isNew = true;
        let fromExtension = false;
        const state = {
            mindset: null,
            direction: null,
            status: 'encours',
            checklist: { liqHTF: false, liqLTF: false, bos: false, objectif: false },
            options: {},
            scores: { liqHTF: 0, liqLTF: 0, bos: 0, objectif: 0 },
            images: { entry: null, context: null, exit: null }
        };

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            tradeId = params.get('id');
            fromExtension = params.get('from') === 'extension';
            
            if (tradeId) {
                isNew = false;
                await loadTrade(tradeId);
                document.getElementById('btnDelete').style.display = 'block';
                document.getElementById('btnSave').textContent = 'üíæ Mettre √† jour';
            } else {
                setDefaults();
                
                // Si on vient de l'extension, pr√©remplir avec les param√®tres URL
                if (fromExtension) {
                    prefillFromExtension(params);
                }
            }

            setupOptionButtons();
            setupImageInputs();
            setupDropZones();
        });

        // Pr√©remplir depuis les param√®tres de l'extension
        function prefillFromExtension(params) {
            // Afficher le banner
            document.getElementById('extensionBanner').style.display = 'flex';
            
            // Asset
            const asset = params.get('asset');
            if (asset) {
                document.getElementById('asset').value = asset.toUpperCase();
            }
            
            // Direction
            const direction = params.get('direction');
            if (direction) {
                setDirection(direction);
            }
            
            // Mindset
            const mindset = params.get('mindset');
            if (mindset) {
                setMindset(mindset);
            }
            
            // Date et heure
            const date = params.get('date');
            if (date) {
                document.getElementById('tradeDate').value = date;
            }
            
            const time = params.get('time');
            if (time) {
                document.getElementById('tradeTime').value = time;
            }
            
            // Timeframe (essayer de mapper vers LTF)
            const tf = params.get('tf');
            if (tf) {
                const tfLower = tf.toLowerCase();
                const tfSelect = document.getElementById('tfLTF');
                // Mapper les timeframes TradingView vers nos options
                const tfMap = {
                    '1': 'M1', '1m': 'M1',
                    '5': 'M5', '5m': 'M5',
                    '15': 'M15', '15m': 'M15',
                    '30': 'M30', '30m': 'M30',
                    '60': 'H1', '1h': 'H1',
                    '240': 'H4', '4h': 'H4',
                    'd': 'D1', '1d': 'D1'
                };
                const mappedTf = tfMap[tfLower] || tfMap[tf];
                if (mappedTf) {
                    tfSelect.value = mappedTf;
                }
            }
            
            // Mettre en √©vidence la zone de drop pour l'image
            const dropEntry = document.getElementById('dropEntry');
            dropEntry.classList.add('from-extension');
            dropEntry.focus();
            
            // Toast personnalis√© selon le mindset
            if (mindset === 'intuitif') {
                showToast('üé≤ Mode intuitif - Ctrl+V pour le screenshot');
            } else {
                showToast('üì∏ Ctrl+V pour coller le screenshot');
            }
        }

        // Set defaults for new trade
        function setDefaults() {
            const now = new Date();
            document.getElementById('tradeDate').value = now.toISOString().split('T')[0];
            document.getElementById('tradeTime').value = now.toTimeString().slice(0, 5);
            setStatus('encours');
        }

        // Load existing trade
        async function loadTrade(id) {
            try {
                const trade = await getTrade(id);
                
                // Identification
                document.getElementById('asset').value = trade.asset || '';
                document.getElementById('tradeDate').value = trade.trade_date || '';
                document.getElementById('tradeTime').value = trade.trade_time?.slice(0, 5) || '';
                document.getElementById('tfHTF').value = trade.tf_htf || '';
                document.getElementById('tfLTF').value = trade.tf_ltf || '';
                document.getElementById('mode').value = trade.mode || 'live';
                
                if (trade.mindset) setMindset(trade.mindset);
                if (trade.direction) setDirection(trade.direction);
                
                // Checklist
                if (trade.liq_htf) {
                    toggleChecklist('liqHTF', true);
                    if (trade.liq_htf_type) setOption('liqHTFType', trade.liq_htf_type);
                    if (trade.liq_htf_force) setOption('liqHTFForce', trade.liq_htf_force);
                }
                if (trade.liq_ltf) {
                    toggleChecklist('liqLTF', true);
                    if (trade.liq_ltf_type) setOption('liqLTFType', trade.liq_ltf_type);
                    if (trade.liq_ltf_force) setOption('liqLTFForce', trade.liq_ltf_force);
                }
                if (trade.bos) {
                    toggleChecklist('bos', true);
                    if (trade.bos_avant_cloture) setOption('bosAvantCloture', trade.bos_avant_cloture);
                    if (trade.bos_meche_corps) setOption('bosMecheCorps', trade.bos_meche_corps);
                    if (trade.bos_liquidite) setOption('bosLiquidite', trade.bos_liquidite);
                }
                if (trade.objectif) {
                    toggleChecklist('objectif', true);
                    if (trade.objectif_type) setOption('objectifType', trade.objectif_type);
                }
                
                // Scores
                if (trade.score_liq_htf) setScore('liqHTF', trade.score_liq_htf);
                if (trade.score_liq_ltf) setScore('liqLTF', trade.score_liq_ltf);
                if (trade.score_bos) setScore('bos', trade.score_bos);
                if (trade.score_objectif) setScore('objectif', trade.score_objectif);
                
                // Images
                if (trade.img_entry) loadImagePreview('entry', trade.img_entry);
                if (trade.img_context) loadImagePreview('context', trade.img_context);
                if (trade.img_exit) loadImagePreview('exit', trade.img_exit);
                
                // R√©sultat
                if (trade.status) setStatus(trade.status);
                document.getElementById('potentielR').value = trade.potentiel_r || '';
                document.getElementById('rObtenu').value = trade.r_obtenu || '';
                document.getElementById('notes').value = trade.notes_exit || '';
                
                updateStatusBadge(trade.status);
                
            } catch (error) {
                console.error('Erreur chargement:', error);
                showToast('‚ùå Erreur de chargement', true);
            }
        }

        // Mindset
        function setMindset(value) {
            state.mindset = value;
            document.querySelectorAll('.mindset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
        }

        // Direction
        function setDirection(value) {
            state.direction = value;
            document.querySelectorAll('.direction-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(value));
            });
        }

        // Status
        function setStatus(value) {
            state.status = value;
            document.querySelectorAll('.result-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(value)) btn.classList.add('active');
            });
            updateStatusBadge(value);
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('statusBadge');
            const badges = {
                'encours': 'üîÑ En cours',
                'tp': '‚úÖ TP',
                'be': '‚öñÔ∏è BE',
                'sl': '‚ùå SL',
                'positif': 'üí∞ Positif'
            };
            badge.textContent = badges[status] || '';
            badge.className = `badge ${status}`;
        }

        // Checklist
        function toggleChecklist(id, forceOpen = false) {
            if (forceOpen) {
                state.checklist[id] = true;
            } else {
                state.checklist[id] = !state.checklist[id];
            }
            
            const checkbox = document.getElementById(`check${id.charAt(0).toUpperCase() + id.slice(1)}`);
            const details = document.getElementById(`details${id.charAt(0).toUpperCase() + id.slice(1)}`);
            
            checkbox.classList.toggle('checked', state.checklist[id]);
            details.classList.toggle('visible', state.checklist[id]);
        }

        // Options
        function setupOptionButtons() {
            document.querySelectorAll('.option-group').forEach(group => {
                group.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        state.options[group.dataset.field] = btn.dataset.value;
                    });
                });
            });
        }

        function setOption(field, value) {
            state.options[field] = value;
            const group = document.querySelector(`[data-field="${field}"]`);
            if (group) {
                group.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === value);
                });
            }
        }

        // Scores
        function setScore(key, value) {
            state.scores[key] = value;
            const container = document.querySelector(`[data-score="${key}"]`);
            container.querySelectorAll('.star').forEach((star, i) => {
                star.classList.toggle('active', i < value);
                star.textContent = i < value ? '‚òÖ' : '‚òÜ';
            });
            updateScoreAvg();
        }

        function updateScoreAvg() {
            const scores = Object.values(state.scores).filter(s => s > 0);
            const avg = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : '-';
            document.getElementById('scoreAvg').textContent = avg;
        }

        // Images
        function setupImageInputs() {
            ['Entry', 'Context', 'Exit'].forEach(type => {
                const input = document.getElementById(`img${type}Url`);
                input.addEventListener('change', async () => {
                    const url = input.value.trim();
                    if (url) {
                        try {
                            const imageUrl = await downloadTradingViewImage(url);
                            loadImagePreview(type.toLowerCase(), imageUrl);
                        } catch (error) {
                            showToast('‚ùå URL invalide', true);
                        }
                    }
                });
            });
        }

        function setupDropZones() {
            ['entry', 'context', 'exit'].forEach(type => {
                const dropZone = document.getElementById(`drop${type.charAt(0).toUpperCase() + type.slice(1)}`);
                
                // Drag & drop
                dropZone.addEventListener('dragover', e => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', async e => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        await handleImageUpload(type, file);
                    }
                });
                
                // Click to select
                dropZone.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = async e => {
                        if (e.target.files[0]) {
                            await handleImageUpload(type, e.target.files[0]);
                        }
                    };
                    input.click();
                });
                
                // Paste (Ctrl+V) - fonctionne m√™me sans focus si c'est le premier champ
                dropZone.addEventListener('paste', async e => {
                    const items = e.clipboardData.items;
                    for (const item of items) {
                        if (item.type.startsWith('image/')) {
                            e.preventDefault();
                            const file = item.getAsFile();
                            await handleImageUpload(type, file);
                            // Enlever le highlight de l'extension
                            dropZone.classList.remove('from-extension');
                            return;
                        }
                    }
                });
            });
            
            // Global paste handler pour coller dans entry par d√©faut si vient de l'extension
            document.addEventListener('paste', async e => {
                if (!fromExtension) return;
                if (state.images.entry) return; // D√©j√† une image
                
                const items = e.clipboardData.items;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        await handleImageUpload('entry', file);
                        document.getElementById('dropEntry').classList.remove('from-extension');
                        document.getElementById('extensionBanner').style.display = 'none';
                        return;
                    }
                }
            });
        }

        async function handleImageUpload(type, file) {
            try {
                showToast('üì§ Upload en cours...');
                const id = tradeId || 'new_' + Date.now();
                const url = await uploadImage(file, id, type);
                state.images[type] = url;
                loadImagePreview(type, url);
                showToast('‚úÖ Image upload√©e');
            } catch (error) {
                console.error('Erreur upload:', error);
                showToast('‚ùå Erreur upload', true);
            }
        }

        function loadImagePreview(type, url) {
            const Type = type.charAt(0).toUpperCase() + type.slice(1);
            state.images[type] = url;
            document.getElementById(`preview${Type}`).src = url;
            document.getElementById(`preview${Type}Container`).classList.add('visible');
            document.getElementById(`drop${Type}`).style.display = 'none';
            document.getElementById(`img${Type}Url`).value = url;
        }

        function removeImage(type) {
            const Type = type.charAt(0).toUpperCase() + type.slice(1);
            state.images[type] = null;
            document.getElementById(`preview${Type}Container`).classList.remove('visible');
            document.getElementById(`drop${Type}`).style.display = 'flex';
            document.getElementById(`img${Type}Url`).value = '';
        }

        // Zoom image
        function zoomImage(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.add('visible');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('visible');
        }

        // Save
        async function handleSave() {
            const asset = document.getElementById('asset').value.toUpperCase().trim();
            if (!asset) {
                showToast('‚ùå Actif requis', true);
                return;
            }
            if (!state.direction) {
                showToast('‚ùå Direction requise', true);
                return;
            }

            const btnSave = document.getElementById('btnSave');
            btnSave.disabled = true;
            btnSave.textContent = '‚è≥ Sauvegarde...';

            try {
                const scores = state.scores;
                const activeScores = Object.values(scores).filter(s => s > 0);
                const scoreAvg = activeScores.length > 0 
                    ? (activeScores.reduce((a, b) => a + b, 0) / activeScores.length).toFixed(1) 
                    : null;

                const tradeData = {
                    asset: asset,
                    direction: state.direction,
                    trade_date: document.getElementById('tradeDate').value,
                    trade_time: document.getElementById('tradeTime').value,
                    tf_htf: document.getElementById('tfHTF').value || null,
                    tf_ltf: document.getElementById('tfLTF').value || null,
                    mode: document.getElementById('mode').value,
                    mindset: state.mindset,
                    
                    liq_htf: state.checklist.liqHTF,
                    liq_htf_type: state.options.liqHTFType || null,
                    liq_htf_force: state.options.liqHTFForce || null,
                    
                    liq_ltf: state.checklist.liqLTF,
                    liq_ltf_type: state.options.liqLTFType || null,
                    liq_ltf_force: state.options.liqLTFForce || null,
                    
                    bos: state.checklist.bos,
                    bos_avant_cloture: state.options.bosAvantCloture || null,
                    bos_meche_corps: state.options.bosMecheCorps || null,
                    bos_liquidite: state.options.bosLiquidite || null,
                    
                    objectif: state.checklist.objectif,
                    objectif_type: state.options.objectifType || null,
                    
                    score_liq_htf: scores.liqHTF || null,
                    score_liq_ltf: scores.liqLTF || null,
                    score_bos: scores.bos || null,
                    score_objectif: scores.objectif || null,
                    score_avg: scoreAvg ? parseFloat(scoreAvg) : null,
                    
                    status: state.status,
                    potentiel_r: parseFloat(document.getElementById('potentielR').value) || null,
                    r_obtenu: parseFloat(document.getElementById('rObtenu').value) || null,
                    notes_exit: document.getElementById('notes').value || null,
                    
                    img_entry: state.images.entry || null,
                    img_context: state.images.context || null,
                    img_exit: state.images.exit || null
                };

                if (isNew) {
                    const newTrade = await createTrade(tradeData);
                    tradeId = newTrade.id;
                    isNew = false;
                    showToast('‚úÖ Trade cr√©√© !');
                    // Redirect to edit mode
                    window.history.replaceState({}, '', `trade.html?id=${tradeId}`);
                    document.getElementById('btnDelete').style.display = 'block';
                } else {
                    await updateTrade(tradeId, tradeData);
                    showToast('‚úÖ Trade mis √† jour !');
                }

                btnSave.textContent = 'üíæ Enregistrer';
                btnSave.disabled = false;

            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showToast('‚ùå Erreur de sauvegarde', true);
                btnSave.textContent = 'üíæ Enregistrer';
                btnSave.disabled = false;
            }
        }

        // Delete
        async function handleDelete() {
            if (!confirm('Supprimer ce trade ?')) return;
            
            try {
                await deleteTrade(tradeId);
                showToast('üóëÔ∏è Trade supprim√©');
                setTimeout(() => window.location.href = 'index.html', 1000);
            } catch (error) {
                showToast('‚ùå Erreur de suppression', true);
            }
        }

        // Toast
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        // Keyboard
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                handleSave();
            }
        });
    </script>
</body>
</html>
